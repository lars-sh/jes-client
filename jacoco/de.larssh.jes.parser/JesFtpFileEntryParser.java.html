<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JesFtpFileEntryParser.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JES Client</a> &gt; <a href="index.source.html" class="el_package">de.larssh.jes.parser</a> &gt; <span class="el_source">JesFtpFileEntryParser.java</span></div><h1>JesFtpFileEntryParser.java</h1><pre class="source lang-java linenums">// Generated by delombok at Thu Sep 07 14:20:06 UTC 2023
package de.larssh.jes.parser;

import static de.larssh.utils.text.Strings.NEW_LINE;
import static java.util.stream.Collectors.toList;
import java.io.BufferedReader;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Optional;
import java.util.OptionalInt;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import org.apache.commons.net.ftp.FTPFileEntryParser;
import de.larssh.jes.Job;
import de.larssh.jes.JobFlag;
import de.larssh.jes.JobOutput;
import de.larssh.jes.JobStatus;
import de.larssh.utils.Nullables;
import de.larssh.utils.Optionals;
import de.larssh.utils.text.Lines;
import de.larssh.utils.text.Patterns;
import de.larssh.utils.text.Strings;
import edu.umd.cs.findbugs.annotations.NonNull;
import edu.umd.cs.findbugs.annotations.Nullable;
import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;

/**
 * Implementation of {@link FTPFileEntryParser} for IBM z/OS JES spools,
 * converting that information into a {@link JesFtpFile} instance.
 */
public class JesFtpFileEntryParser implements FTPFileEntryParser {
	/**
	 * Pattern to match the job details header response line
	 */
<span class="fc" id="L37">	private static final Pattern PATTERN_TITLE = Pattern.compile(&quot;^JOBNAME +JOBID +OWNER +STATUS +CLASS *$&quot;, Pattern.CASE_INSENSITIVE);</span>
	/**
	 * Pattern to match job details lines inside response
	 *
	 * &lt;p&gt;
	 * List of named groups:
	 * &lt;ul&gt;
	 * &lt;li&gt;name
	 * &lt;li&gt;id
	 * &lt;li&gt;owner
	 * &lt;li&gt;status
	 * &lt;li&gt;class
	 * &lt;li&gt;rest
	 * &lt;/ul&gt;
	 */
<span class="fc" id="L52">	private static final Pattern PATTERN_JOB = Pattern.compile(&quot;^(?&lt;name&gt;[^ ]+) +(?&lt;id&gt;[^ ]+) +(?&lt;owner&gt;[^ ]+) +(?&lt;status&gt;(INPUT|ACTIVE|OUTPUT)) +(?&lt;class&gt;[^ ]+)( +(?&lt;rest&gt;.*))?$&quot;, Pattern.CASE_INSENSITIVE);</span>
	/**
	 * Pattern to find the abend code inside a response line
	 *
	 * &lt;p&gt;
	 * List of named groups:
	 * &lt;ul&gt;
	 * &lt;li&gt;abend
	 * &lt;/ul&gt;
	 */
<span class="fc" id="L62">	private static final Pattern PATTERN_JOB_ABEND = Pattern.compile(&quot;ABEND=(?&lt;abend&gt;\\S+)&quot;, Pattern.CASE_INSENSITIVE);</span>
	/**
	 * Pattern to find the result code inside a response line
	 *
	 * &lt;p&gt;
	 * List of named groups:
	 * &lt;ul&gt;
	 * &lt;li&gt;returnCode
	 * &lt;/ul&gt;
	 */
<span class="fc" id="L72">	private static final Pattern PATTERN_JOB_RETURN_CODE = Pattern.compile(&quot;RC=(?&lt;returnCode&gt;\\d+)&quot;, Pattern.CASE_INSENSITIVE);</span>
	/**
	 * Pattern to match the separator response line OR an output warning
	 */
<span class="fc" id="L76">	private static final Pattern PATTERN_GARBAGE = Pattern.compile(&quot;^(-+|STEP, PROC, CPUT, and ELAPT unknown) *$&quot;, Pattern.CASE_INSENSITIVE);</span>
	/**
	 * Pattern to match the job output header response line
	 */
<span class="fc" id="L80">	private static final Pattern PATTERN_SUB_TITLE = Pattern.compile(&quot;^ {9}ID  STEPNAME PROCSTEP C DDNAME   (BYTE|REC)-COUNT( COMMENT)? *$&quot;, Pattern.CASE_INSENSITIVE);</span>
	/**
	 * Pattern to match job output lines inside response
	 *
	 * &lt;p&gt;
	 * List of named groups:
	 * &lt;ul&gt;
	 * &lt;li&gt;index
	 * &lt;li&gt;step
	 * &lt;li&gt;procedureStep
	 * &lt;li&gt;class
	 * &lt;li&gt;name
	 * &lt;li&gt;length
	 * &lt;/ul&gt;
	 */
<span class="fc" id="L95">	private static final Pattern PATTERN_JOB_OUTPUT = Pattern.compile(&quot;^ {9}(?&lt;index&gt;\\d{3}) (?&lt;step&gt;.{8}) (?&lt;procedureStep&gt;.{8}) (?&lt;class&gt;.) (?&lt;name&gt;.{8}) +(?&lt;length&gt;\\d+) *$&quot;);</span>
	/**
	 * Pattern to match the response line containing the number of spool files
	 */
<span class="fc" id="L99">	private static final Pattern PATTERN_SPOOL_FILES = Pattern.compile(&quot;^\\d+ spool files *$&quot;, Pattern.CASE_INSENSITIVE);</span>

	/**
	 * Builds a {@link Job} object based on a job details response {@code line}.
	 *
	 * @param line job details response line
	 * @return {@link Job} object
	 */
	@SuppressWarnings(&quot;checkstyle:MultipleStringLiterals&quot;)
	private Job createJob(final String line) {
<span class="fc" id="L109">		final Matcher matcher = Patterns.matches(PATTERN_JOB, line).orElseThrow(() -&gt; new JesFtpFileEntryParserException(&quot;Expected [%s] as job details line, got [%s].&quot;, PATTERN_JOB.pattern(), line));</span>
<span class="fc" id="L110">		final String jobId = matcher.group(&quot;id&quot;);</span>
<span class="fc" id="L111">		final String name = matcher.group(&quot;name&quot;);</span>
<span class="fc" id="L112">		final JobStatus status = JobStatus.valueOf(matcher.group(&quot;status&quot;));</span>
<span class="fc" id="L113">		final String owner = matcher.group(&quot;owner&quot;);</span>
<span class="fc" id="L114">		final Optional&lt;String&gt; jesClass = Optionals.ofNonBlank(matcher.group(&quot;class&quot;));</span>
<span class="fc" id="L115">		final Optional&lt;String&gt; rest = Optionals.ofNonBlank(matcher.group(&quot;rest&quot;));</span>
<span class="fc" id="L116">		final OptionalInt resultCode = Optionals.mapToInt(rest.flatMap(r -&gt; Patterns.find(PATTERN_JOB_RETURN_CODE, r)).map(m -&gt; m.group(&quot;returnCode&quot;)), Integer::parseInt);</span>
<span class="fc" id="L117">		final Optional&lt;String&gt; abendCode = rest.flatMap(r -&gt; Patterns.find(PATTERN_JOB_ABEND, r)).map(m -&gt; m.group(&quot;abend&quot;));</span>
<span class="fc" id="L118">		final List&lt;JobFlag&gt; flags = Arrays.stream(JobFlag.values()).filter(flag -&gt; rest.map(r -&gt; Patterns.find(flag.getRestPattern(), r).isPresent()).orElse(Boolean.FALSE)).collect(toList());</span>
<span class="fc" id="L119">		return new Job(jobId, name, status, owner, jesClass, resultCode, abendCode, flags.toArray(new JobFlag[0]));</span>
	}

	/**
	 * Parses {@code listEntry} and builds a {@link Job} object based on the given
	 * content.
	 *
	 * &lt;p&gt;
	 * Job details and job outputs were joined together using
	 * {@link #preParse(List)} before.
	 *
	 * @param listEntry one logical line from the file listing
	 * @return {@link Job} object
	 * @throws JesFtpFileEntryParserException on unexpected {@code listEntry}
	 */
	@SuppressWarnings(&quot;PMD.CyclomaticComplexity&quot;)
	private Job createJobAndOutputs(final String listEntry) {
<span class="fc" id="L136">		final List&lt;String&gt; lines = new ArrayList&lt;&gt;(Lines.lines(listEntry));</span>
<span class="fc bfc" id="L137" title="All 2 branches covered.">		if (lines.isEmpty()) {</span>
<span class="fc" id="L138">			throw new JesFtpFileEntryParserException(&quot;Expected [%s] as job details line, got no line.&quot;, PATTERN_JOB.pattern());</span>
		}
		// First line (job)
<span class="fc" id="L141">		final Job job = createJob(lines.remove(0));</span>
		// Second line(s) (optional garbage, e.g. a separator line or an output warning)
<span class="fc bfc" id="L143" title="All 4 branches covered.">		while (!lines.isEmpty() &amp;&amp; Strings.matches(lines.get(0), PATTERN_GARBAGE)) {</span>
<span class="fc" id="L144">			lines.remove(0);</span>
		}
		// Third line (sub title)
<span class="fc bfc" id="L147" title="All 2 branches covered.">		if (lines.isEmpty()) {</span>
<span class="fc" id="L148">			return job;</span>
		}
<span class="fc" id="L150">		final String subTitle = lines.remove(0);</span>
<span class="fc bfc" id="L151" title="All 2 branches covered.">		if (!Strings.matches(subTitle, PATTERN_SUB_TITLE)) {</span>
<span class="fc" id="L152">			throw new JesFtpFileEntryParserException(&quot;Expected [%s] as sub title line, got [%s].&quot;, PATTERN_SUB_TITLE.pattern(), subTitle);</span>
		}
		// Last line (spool files, optional)
<span class="fc bfc" id="L155" title="All 2 branches covered.">		if (!lines.isEmpty()) {</span>
<span class="fc" id="L156">			final String spoolFiles = lines.get(lines.size() - 1);</span>
<span class="fc bfc" id="L157" title="All 2 branches covered.">			if (Strings.matches(spoolFiles, PATTERN_SPOOL_FILES)) {</span>
<span class="fc" id="L158">				lines.remove(lines.size() - 1);</span>
			}
		}
		// Further lines (job outputs)
<span class="fc bfc" id="L162" title="All 2 branches covered.">		for (final String line : lines) {</span>
<span class="fc" id="L163">			createJobOutput(job, line);</span>
<span class="fc" id="L164">		}</span>
<span class="fc" id="L165">		return job;</span>
	}

	/**
	 * Builds a {@link JobOutput} object based on a job output response
	 * {@code line}.
	 *
	 * @param job  related job
	 * @param line job details response line
	 * @return {@link JobOutput} object
	 */
	@SuppressWarnings(&quot;checkstyle:MultipleStringLiterals&quot;)
	private JobOutput createJobOutput(final Job job, final String line) {
<span class="fc" id="L178">		final Matcher matcher = Patterns.matches(PATTERN_JOB_OUTPUT, line).orElseThrow(() -&gt; new JesFtpFileEntryParserException(&quot;Expected [%s] as job output details line, got [%s].&quot;, PATTERN_JOB_OUTPUT.pattern(), line));</span>
<span class="fc" id="L179">		final int index = Integer.parseInt(matcher.group(&quot;index&quot;));</span>
<span class="fc" id="L180">		final String name = matcher.group(&quot;name&quot;);</span>
<span class="fc" id="L181">		final int length = Integer.parseInt(matcher.group(&quot;length&quot;));</span>
<span class="fc" id="L182">		final Optional&lt;String&gt; step = Optionals.ofNonBlank(matcher.group(&quot;step&quot;));</span>
<span class="fc" id="L183">		final Optional&lt;String&gt; procedureStep = Optionals.ofNonBlank(matcher.group(&quot;procedureStep&quot;));</span>
<span class="fc" id="L184">		final Optional&lt;String&gt; jesClass = Optionals.ofNonBlank(matcher.group(&quot;class&quot;));</span>
<span class="fc" id="L185">		return job.createOutput(index, name, length, step, procedureStep, jesClass);</span>
	}

	/**
	 * {@inheritDoc}
	 */
	@Nullable
	@Override
	public JesFtpFile parseFTPEntry(@Nullable final String listEntryNullable) {
<span class="fc" id="L194">		final String listEntry = Nullables.orElseThrow(listEntryNullable);</span>
<span class="fc" id="L195">		return new JesFtpFile(createJobAndOutputs(listEntry), listEntry);</span>
	}

	/**
	 * {@inheritDoc}
	 */
	@Nullable
	@Override
	@SuppressWarnings({&quot;checkstyle:SuppressWarnings&quot;, &quot;resource&quot;})
	public String readNextEntry(@Nullable final BufferedReader reader) throws IOException {
<span class="fc" id="L205">		return Nullables.orElseThrow(reader).readLine();</span>
	}

	/**
	 * {@inheritDoc}
	 */
	@NonNull
	@Override
	@SuppressWarnings(&quot;PMD.CyclomaticComplexity&quot;)
	@SuppressFBWarnings(value = &quot;CFS_CONFUSING_FUNCTION_SEMANTICS&quot;, justification = &quot;returning input variable as required by interface contract&quot;)
	public List&lt;String&gt; preParse(@Nullable final List&lt;String&gt; originalNullable) {
<span class="fc" id="L216">		final List&lt;String&gt; original = Nullables.orElseThrow(originalNullable);</span>
		// Empty list
<span class="fc bfc" id="L218" title="All 2 branches covered.">		if (original.isEmpty()) {</span>
<span class="fc" id="L219">			throw new JesFtpFileEntryParserException(&quot;Parsing JES job details failed. No line found.&quot;);</span>
		}
		// First line
<span class="fc bfc" id="L222" title="All 2 branches covered.">		if (!Strings.matches(original.get(0), PATTERN_TITLE)) {</span>
<span class="fc" id="L223">			throw new JesFtpFileEntryParserException(&quot;Parsing JES job details failed. Unexpected first line: [%s].&quot;, original.get(0));</span>
		}
		// Iterate over original from 1 to size
		// 1. ignore title line (starting at 1)
		// 2. concatenate lines of the same job to one list entry
		// 3. handle last line (stopping at size)
<span class="fc" id="L229">		final List&lt;String&gt; lines = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L230">		final List&lt;String&gt; linesOfCurrentJob = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L231">		final int size = original.size();</span>
<span class="fc bfc" id="L232" title="All 2 branches covered.">		for (int index = 1; index &lt;= size; index += 1) {</span>
<span class="fc bfc" id="L233" title="All 2 branches covered.">			final boolean isLast = index &gt;= size;</span>
<span class="fc bfc" id="L234" title="All 6 branches covered.">			if ((isLast || Patterns.matches(PATTERN_JOB, original.get(index)).isPresent()) &amp;&amp; !linesOfCurrentJob.isEmpty()) {</span>
<span class="fc" id="L235">				lines.add(String.join(NEW_LINE, linesOfCurrentJob));</span>
<span class="fc" id="L236">				linesOfCurrentJob.clear();</span>
			}
<span class="fc bfc" id="L238" title="All 2 branches covered.">			if (!isLast) {</span>
<span class="fc" id="L239">				linesOfCurrentJob.add(original.get(index));</span>
			}
		}
		// The interface tells us to return the input variable.
<span class="fc" id="L243">		original.clear();</span>
<span class="fc" id="L244">		original.addAll(lines);</span>
<span class="fc" id="L245">		return original;</span>
	}

	@java.lang.SuppressWarnings(&quot;all&quot;)
	@edu.umd.cs.findbugs.annotations.SuppressFBWarnings(justification = &quot;generated code&quot;)
	@lombok.Generated
	public JesFtpFileEntryParser() {
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>